<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CamLive - Chat Vid√©o</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 20px auto; }
    h1 { text-align: center; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    video { width: 100%; aspect-ratio: 16/9; background:#eee; border:1px solid #aaa; }
    #start { margin-top: 8px; padding:10px 16px; }
    .hint { color:#666; font-size:14px; text-align:center; margin-top:8px; }
  </style>
</head>
<body>
  <h1>CamLive - Chat Vid√©o</h1>

  <div class="grid">
    <div>
      <div class="hint">Ta cam√©ra</div>
      <video id="localVideo" autoplay playsinline muted></video>
    </div>
    <div>
      <div class="hint">L'autre participant</div>
      <video id="remoteVideo" autoplay playsinline></video>
    </div>
  </div>

  <button id="start">D√©marrer</button>
  <div class="hint">Ouvre cette page sur <b>2 appareils</b> (Mac + iPhone 4G), clique ‚ÄúD√©marrer‚Äù des deux c√¥t√©s et autorise cam√©ra & micro.</div>

  <!-- Socket.io -->
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

  <script>
    // 1) Connexion au serveur de signalisation (Render) en HTTPS
    const socket = io("https://camlive-backend.onrender.com", {
      path: "/socket.io",
      transports: ["websocket"]
    });

    // 2) RTCPeerConnection avec STUN (tu pourras ajouter TURN plus tard)
    const pc = new RTCPeerConnection({
      iceServers: [
        { urls: "stun:stun.l.google.com:19302" },
        { urls: "stun:global.stun.twilio.com:3478?transport=udp" }
      ]
    });

    const localVideo  = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");
    const startBtn    = document.getElementById("start");

    let localStream;

    // Ouvre la cam√©ra avec limites (r√©solution/FPS) et param√®tres d'envoi (bitrate)
    async function ensureLocalStream() {
      if (!localStream) {
        localStream = await navigator.mediaDevices.getUserMedia({
          video: {
            width:  { ideal: 640 },   // ‚âà 360p (plus fluide)
            height: { ideal: 360 },
            frameRate: { ideal: 24, max: 30 }
          },
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: true
          }
        });

        // Ajouter les pistes au peer connection
        localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
        localVideo.srcObject = localStream;

        // Limiter le d√©bit vid√©o (pour √©viter les saccades)
        const vSender = pc.getSenders().find(s => s.track && s.track.kind === "video");
        if (vSender) {
          const params = vSender.getParameters();
          params.encodings = [{
            maxBitrate: 800_000,   // ~800 kb/s (monte √† 1_200_000 si tr√®s bon r√©seau)
            maxFramerate: 30
          }];
          await vSender.setParameters(params);
        }

        // Aide iOS : indiquer que c‚Äôest de la ‚Äúmotion‚Äù
        const vTrack = localStream.getVideoTracks()[0];
        if (vTrack && "contentHint" in vTrack) vTrack.contentHint = "motion";
      }
    }

    // Logs utiles (F12 ‚Üí Console)
    pc.oniceconnectionstatechange = () => console.log("ICE:", pc.iceConnectionState);
    pc.onconnectionstatechange   = () => console.log("PC:", pc.connectionState);

    // R√©ception de la vid√©o distante
    pc.ontrack = (e) => {
      console.log("üìπ Flux distant re√ßu");
      remoteVideo.srcObject = e.streams[0];
    };

    // 3) Tu d√©marres ‚Üí tu envoies l'offre
    startBtn.onclick = async () => {
      try {
        await ensureLocalStream();
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        socket.emit("offer", offer);
      } catch (err) {
        console.error("Erreur cam√©ra/micro :", err);
        alert("Impossible d'acc√©der √† la cam√©ra ou au micro.");
      }
    };

    // 4) Quand tu re√ßois une offre ‚Üí tu ouvres ta cam puis tu r√©ponds
    socket.on("offer", async (offer) => {
      await ensureLocalStream();
      await pc.setRemoteDescription(new RTCSessionDescription(offer));
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      socket.emit("answer", answer);
    });

    // 5) Quand tu re√ßois une r√©ponse
    socket.on("answer", async (answer) => {
      await pc.setRemoteDescription(new RTCSessionDescription(answer));
    });

    // 6) √âchange des candidats ICE
    pc.onicecandidate = (e) => { if (e.candidate) socket.emit("candidate", e.candidate); };
    socket.on("candidate", async (c) => {
      try { await pc.addIceCandidate(new RTCIceCandidate(c)); }
      catch (err) { console.error("ICE add error", err); }
    });
  </script>
</body>
</html>